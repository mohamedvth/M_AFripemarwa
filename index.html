<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SCAPCB Mobile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Scripts Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        /* [Tout le CSS précédent reste inchangé] */
    </style>
</head>
<body>
    <div class="login-overlay" id="loginOverlay">
        <!-- [Le contenu du formulaire de login reste inchangé] -->
    </div>
    
    <div class="container" id="mainApp">
        <!-- [Le contenu de l'application principale reste inchangé] -->
    </div>

    <div class="share-overlay" id="shareOverlay" style="display: none;">
        <!-- [Le contenu du menu de partage reste inchangé] -->
    </div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCvMFXC4eSZ1PufU5bh_zhnmhJaUN_CJ_s",
            authDomain: "akekemld.firebaseapp.com",
            projectId: "akekemld",
            storageBucket: "akekemld.firebasestorage.app",
            messagingSenderId: "143116802875",
            appId: "1:143116802875:web:e0a61cac3559df321cb51e"
        };

        // Initialiser Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // DOM elements
        const loginOverlay = document.getElementById('loginOverlay');
        const mainApp = document.getElementById('mainApp');
        const loginBtn = document.getElementById('loginBtn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const passwordToggle = document.getElementById('passwordToggle');
        const sessionStatus = document.getElementById('sessionStatus');
        
        // Initialize variables
        let interventions = [];
        let equipmentList = [];
        let nextId = 1;
        let isLoggedIn = false;
        let loginAttempts = 0;
        const MAX_LOGIN_ATTEMPTS = 3;
        let isEditing = false;
        let currentEditId = null;
        let deviceId = generateDeviceId();
        
        // Generate unique device ID
        function generateDeviceId() {
            return 'device-' + Math.random().toString(36).substr(2, 9);
        }
        
        // Password visibility toggle
        passwordToggle.addEventListener('click', () => {
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordToggle.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                passwordInput.type = 'password';
                passwordToggle.innerHTML = '<i class="fas fa-eye"></i>';
            }
        });
        
        // Login functionality
        loginBtn.addEventListener('click', async () => {
            const email = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            // Security: limit login attempts
            loginAttempts++;
            if (loginAttempts > MAX_LOGIN_ATTEMPTS) {
                loginError.textContent = "Trop de tentatives échouées. Veuillez réessayer plus tard.";
                loginError.style.display = 'block';
                loginBtn.disabled = true;
                setTimeout(() => {
                    loginBtn.disabled = false;
                    loginAttempts = 0;
                }, 30000); // 30 seconds lockout
                return;
            }
            
            try {
                // Authentification avec Firebase
                await auth.signInWithEmailAndPassword(email, password);
                
                isLoggedIn = true;
                sessionStatus.textContent = "Connecté";
                
                // Charger les données depuis Firestore
                await loadFromFirestore();
                
                loginOverlay.style.display = 'none';
                mainApp.style.display = 'block';
                renderEquipmentList();
                renderInterventionList();
                updateStats();
                
            } catch (error) {
                console.error("Erreur de connexion:", error);
                loginError.textContent = error.message || "Identifiants incorrects";
                loginError.style.display = 'block';
                usernameInput.style.border = '2px solid #ff3333';
                passwordInput.style.border = '2px solid #ff3333';
                
                // Clear password field
                passwordInput.value = '';
            }
        });
        
        // Nouvelle fonction: Charger depuis Firestore
        async function loadFromFirestore() {
            const user = auth.currentUser;
            if (!user) return;

            try {
                const snapshot = await db.collection('interventions').get();
                interventions = [];
                let maxId = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    interventions.push(data);
                    if (data.id > maxId) maxId = data.id;
                });

                nextId = maxId + 1;
            } catch (error) {
                console.error("Erreur de chargement Firestore:", error);
                showSyncStatus("Erreur de chargement des données", false);
            }
        }

        // Logout functionality
        logoutBtn.addEventListener('click', () => {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter?')) {
                logout();
            }
        });
        
        // Logout function
        function logout() {
            auth.signOut();
            isLoggedIn = false;
            sessionStatus.textContent = "Session sécurisée";
            mainApp.style.display = 'none';
            loginOverlay.style.display = 'flex';
            usernameInput.value = '';
            passwordInput.value = '';
            loginError.style.display = 'none';
            usernameInput.style.border = '';
            passwordInput.style.border = '';
            
            // Clear any sensitive data from memory
            interventions = [];
            equipmentList = [];
            nextId = 1;
            resetForm();
        }
        
        // Toggle interventions button
        const toggleBtn = document.getElementById('toggleInterventions');
        const interventionListSection = document.getElementById('interventionListSection');
        let interventionsVisible = true;
        
        toggleBtn.addEventListener('click', () => {
            interventionsVisible = !interventionsVisible;
            
            if (interventionsVisible) {
                interventionListSection.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> <span>Masquer</span>';
            } else {
                interventionListSection.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i> <span>Afficher</span>';
            }
        });
        
        // DOM elements for the main app
        const interventionForm = document.getElementById('interventionForm');
        const addEquipmentBtn = document.getElementById('addEquipment');
        const equipmentInput = document.getElementById('equipment');
        const equipmentListEl = document.getElementById('equipmentList');
        const interventionListEl = document.getElementById('interventionList');
        const exportExcelBtn = document.getElementById('exportExcel');
        const cancelEditBtn = document.getElementById('cancelEdit');
        const formTitle = document.getElementById('formTitle');
        const submitBtn = document.getElementById('submitBtn');
        const interventionIdInput = document.getElementById('interventionId');
        
        // Stats elements
        const totalInterventionsEl = document.getElementById('totalInterventions');
        const inProgressEl = document.getElementById('inProgress');
        const completedEl = document.getElementById('completed');
        const totalEquipmentEl = document.getElementById('totalEquipment');
        
        // Filter elements
        const filterType = document.getElementById('filterType');
        const filterMaintenance = document.getElementById('filterMaintenance');
        const filterStatus = document.getElementById('filterStatus');
        const searchInput = document.getElementById('searchInput');
        
        // Add equipment to the list
        addEquipmentBtn.addEventListener('click', () => {
            const equipment = equipmentInput.value.trim();
            if (equipment) {
                equipmentList.push(equipment);
                equipmentInput.value = '';
                renderEquipmentList();
            }
        });
        
        // Render equipment list
        function renderEquipmentList() {
            equipmentListEl.innerHTML = '';
            
            if (equipmentList.length === 0) {
                equipmentListEl.innerHTML = '<p style="text-align: center; color: #95a5a6; padding: 10px;">Aucun équipement ajouté</p>';
                return;
            }
            
            equipmentList.forEach((equipment, index) => {
                const item = document.createElement('div');
                item.className = 'equipment-item';
                item.innerHTML = `
                    <span>${equipment}</span>
                    <button class="remove-equipment" data-index="${index}"><i class="fas fa-trash"></i> Supprimer</button>
                `;
                equipmentListEl.appendChild(item);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-equipment').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    equipmentList.splice(index, 1);
                    renderEquipmentList();
                });
            });
        }
        
        // Handle form submission
        interventionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = document.getElementById('user').value;
            const matricule = document.getElementById('matricule').value;
            const interventionType = document.getElementById('interventionType').value;
            const maintenanceType = document.getElementById('maintenanceType').value;
            const priority = document.getElementById('priority').value;
            const status = document.getElementById('status').value;
            const description = document.getElementById('description').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const id = interventionIdInput.value;
            
            if (!user || !matricule || !interventionType || !maintenanceType || !priority || !status || !startDate || !endDate) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                alert('La date de fin ne peut pas être antérieure à la date de début');
                return;
            }
            
            try {
                if (isEditing && id) {
                    // Update existing intervention in Firestore
                    await db.collection('interventions').doc(id).update({
                        user,
                        matricule,
                        interventionType,
                        maintenanceType,
                        priority,
                        status,
                        description,
                        start: startDate,
                        end: endDate,
                        equipment: [...equipmentList],
                        updatedAt: new Date().toISOString(),
                        updatedBy: deviceId
                    });
                    
                    showSyncStatus("Intervention mise à jour avec succès", true);
                } else {
                    // Create new intervention in Firestore
                    const newIntervention = {
                        id: nextId.toString(),
                        user,
                        matricule,
                        interventionType,
                        maintenanceType,
                        priority,
                        status,
                        description,
                        start: startDate,
                        end: endDate,
                        equipment: [...equipmentList],
                        createdAt: new Date().toISOString(),
                        createdBy: deviceId,
                        updatedAt: null,
                        updatedBy: null
                    };
                    
                    await db.collection('interventions').doc(nextId.toString()).set(newIntervention);
                    nextId++;
                    showSyncStatus("Intervention enregistrée avec succès", true);
                }
                
                // Reload data from Firestore
                await loadFromFirestore();
                equipmentList = [];
                renderEquipmentList();
                renderInterventionList();
                updateStats();
                resetForm();
                
            } catch (error) {
                console.error("Erreur de synchronisation:", error);
                showSyncStatus("Échec de la synchronisation", false);
            }
        });
        
        // Reset form to initial state
        function resetForm() {
            interventionForm.reset();
            equipmentList = [];
            renderEquipmentList();
            isEditing = false;
            currentEditId = null;
            formTitle.textContent = "Nouvelle Intervention";
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer';
            cancelEditBtn.style.display = 'none';
            interventionIdInput.value = '';
        }
        
        // Cancel edit mode
        cancelEditBtn.addEventListener('click', resetForm);
        
        // Edit intervention
        function editIntervention(id) {
            const intervention = interventions.find(i => i.id == id);
            if (!intervention) return;
            
            // Fill form with intervention data
            document.getElementById('user').value = intervention.user;
            document.getElementById('matricule').value = intervention.matricule;
            document.getElementById('interventionType').value = intervention.interventionType;
            document.getElementById('maintenanceType').value = intervention.maintenanceType;
            document.getElementById('priority').value = intervention.priority;
            document.getElementById('status').value = intervention.status;
            document.getElementById('description').value = intervention.description || '';
            document.getElementById('startDate').value = intervention.start;
            document.getElementById('endDate').value = intervention.end;
            interventionIdInput.value = intervention.id;
            
            // Set equipment
            equipmentList = [...intervention.equipment];
            renderEquipmentList();
            
            // Change form to edit mode
            isEditing = true;
            currentEditId = id;
            formTitle.textContent = "Modifier Intervention";
            submitBtn.innerHTML = '<i class="fas fa-sync"></i> Mettre à jour';
            cancelEditBtn.style.display = 'block';
            
            // Scroll to form
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Delete intervention
        async function deleteIntervention(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette intervention?')) {
                try {
                    // Delete from Firestore
                    await db.collection('interventions').doc(id.toString()).delete();
                    
                    // Reload data from Firestore
                    await loadFromFirestore();
                    renderInterventionList();
                    updateStats();
                    showSyncStatus("Intervention supprimée avec succès", true);
                    
                    // If we were editing the deleted item, reset form
                    if (isEditing && currentEditId == id) {
                        resetForm();
                    }
                } catch (error) {
                    console.error("Erreur de suppression:", error);
                    showSyncStatus("Échec de la suppression", false);
                }
            }
        }
        
        // Render intervention list
        function renderInterventionList() {
            interventionListEl.innerHTML = '';
            
            // Apply filters
            let filteredInterventions = [...interventions];
            
            // Type filter
            if (filterType.value) {
                filteredInterventions = filteredInterventions.filter(i => i.interventionType === filterType.value);
            }
            
            // Maintenance type filter
            if (filterMaintenance.value) {
                filteredInterventions = filteredInterventions.filter(i => i.maintenanceType === filterMaintenance.value);
            }
            
            // Status filter
            if (filterStatus.value) {
                filteredInterventions = filteredInterventions.filter(i => i.status === filterStatus.value);
            }
            
            // Search filter
            if (searchInput.value) {
                const searchTerm = searchInput.value.toLowerCase();
                filteredInterventions = filteredInterventions.filter(i => 
                    i.user.toLowerCase().includes(searchTerm) || 
                    i.matricule.toLowerCase().includes(searchTerm) ||
                    (i.description && i.description.toLowerCase().includes(searchTerm)) ||
                    i.equipment.some(eq => eq.toLowerCase().includes(searchTerm))
                );
            }
            
            if (filteredInterventions.length === 0) {
                interventionListEl.innerHTML = '<div class="no-interventions"><i class="fas fa-industry" style="font-size: 2.5rem; margin-bottom: 15px; color: #ffcc00;"></i><p>Aucune intervention correspondant aux critères</p></div>';
                return;
            }
            
            // Sort by start date (newest first)
            filteredInterventions.sort((a, b) => new Date(b.start) - new Date(a.start));
            
            filteredInterventions.forEach(intervention => {
                const card = document.createElement('div');
                card.className = `intervention-card priority-${intervention.priority}`;
                
                // Map types to French labels
                const interventionTypeMap = {
                    'electrique': 'Électrique',
                    'mecanique': 'Mécanique',
                    'servise-general': 'Service Général'
                };
                
                const maintenanceTypeMap = {
                    'preventif': 'Préventive',
                    'corective': 'Corrective',
                    'annule': 'Annulée'
                };
                
                const statusMap = {
                    'planned': 'Planifiée',
                    'in-progress': 'En Cours',
                    'completed': 'Terminée',
                    'annule': 'Annulée'
                };
                
                const statusClassMap = {
                    'planned': 'status-planned',
                    'in-progress': 'status-in-progress',
                    'completed': 'status-completed',
                    'annule': 'status-canceled'
                };
                
                card.innerHTML = `
                    <div class="intervention-header">
                        <div class="intervention-title">${intervention.user} (${intervention.matricule})</div>
                        <div>
                            <span class="intervention-type ${intervention.interventionType}">${interventionTypeMap[intervention.interventionType]}</span>
                            <span class="intervention-type ${intervention.maintenanceType}">${maintenanceTypeMap[intervention.maintenanceType]}</span>
                            <span class="status-badge ${statusClassMap[intervention.status]}">${statusMap[intervention.status]}</span>
                        </div>
                    </div>
                    
                    <div class="intervention-details">
                        <div class="detail-item">
                            <span class="detail-label"><i class="far fa-calendar-alt"></i> Début</span>
                            <span class="detail-value">${formatDate(intervention.start)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label"><i class="far fa-calendar-alt"></i> Fin</span>
                            <span class="detail-value">${formatDate(intervention.end)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label"><i class="far fa-clock"></i> Durée</span>
                            <span class="detail-value">${calculateDuration(intervention.start, intervention.end)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label"><i class="fas fa-exclamation-triangle"></i> Priorité</span>
                            <span class="detail-value" style="text-transform: capitalize;">${intervention.priority}</span>
                        </div>
                    </div>
                    
                    ${intervention.description ? `
                    <div class="intervention-description">
                        <div class="description-label"><i class="fas fa-file-alt"></i> Description:</div>
                        <div>${intervention.description}</div>
                    </div>
                    ` : ''}
                    
                    <div class="intervention-equipment">
                        <div class="detail-label"><i class="fas fa-cog"></i> Équipements:</div>
                        ${intervention.equipment.map(eq => `<span class="equipment-tag">${eq}</span>`).join('')}
                    </div>
                    
                    <div class="card-footer">
                        <span class="intervention-id">
                            ID: #${intervention.id} 
                            ${intervention.updatedAt ? `| Mise à jour: ${formatDate(intervention.updatedAt)} <span class="device-badge">${intervention.updatedBy === deviceId ? 'Cet appareil' : 'Autre appareil'}</span>` : `| Créé le: ${formatDate(intervention.createdAt)} <span class="device-badge">${intervention.createdBy === deviceId ? 'Cet appareil' : 'Autre appareil'}</span>`}
                        </span>
                        <div class="action-buttons">
                            <button class="edit-intervention" data-id="${intervention.id}">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                            <button class="delete-intervention" data-id="${intervention.id}">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </div>
                    </div>
                `;
                
                interventionListEl.appendChild(card);
            });
            
            // Add event listeners to action buttons
            document.querySelectorAll('.edit-intervention').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.closest('button').dataset.id;
                    editIntervention(id);
                });
            });
            
            document.querySelectorAll('.delete-intervention').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.closest('button').dataset.id;
                    deleteIntervention(id);
                });
            });
        }
        
        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Calculate duration between two dates
        function calculateDuration(start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            const diff = endDate - startDate;
            
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            
            return `${hours}h ${minutes}min`;
        }
        
        // Update stats
        function updateStats() {
            totalInterventionsEl.textContent = interventions.length;
            
            const inProgress = interventions.filter(i => i.status === 'in-progress').length;
            inProgressEl.textContent = inProgress;
            
            const completed = interventions.filter(i => i.status === 'completed').length;
            completedEl.textContent = completed;
            
            // Calculate total equipment
            let totalEquipment = 0;
            interventions.forEach(intervention => {
                totalEquipment += intervention.equipment.length;
            });
            totalEquipmentEl.textContent = totalEquipment;
        }
        
        // Export to Excel functionality
        exportExcelBtn.addEventListener('click', () => {
            if (interventions.length === 0) {
                alert("Aucune intervention à exporter!");
                return;
            }
            
            // Prepare data for export
            const data = interventions.map(intervention => {
                return {
                    ID: intervention.id,
                    Utilisateur: intervention.user,
                    Matricule: intervention.matricule,
                    "Type d'intervention": intervention.interventionType,
                    "Type de maintenance": intervention.maintenanceType,
                    Priorité: intervention.priority,
                    Statut: intervention.status,
                    Description: intervention.description,
                    "Début d'intervention": formatDate(intervention.start),
                    "Fin d'intervention": formatDate(intervention.end),
                    Durée: calculateDuration(intervention.start, intervention.end),
                    Équipements: intervention.equipment.join(", "),
                    "Date de création": formatDate(intervention.createdAt),
                    "Créé par": intervention.createdBy,
                    "Dernière mise à jour": intervention.updatedAt ? formatDate(intervention.updatedAt) : "",
                    "Mis à jour par": intervention.updatedBy || ""
                };
            });
            
            // Create worksheet
            const worksheet = XLSX.utils.json_to_sheet(data);
            
            // Create workbook
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Interventions");
            
            // Export to Excel file
            XLSX.writeFile(workbook, "interventions_maintenance.xlsx");
        });

        // Fonction pour générer le contenu de l'email
        function generateEmailContent() {
            let content = "Rapport des interventions de maintenance:\n\n";
            
            interventions.forEach(intervention => {
                content += `ID: ${intervention.id}\n`;
                content += `Utilisateur: ${intervention.user}\n`;
                content += `Matricule: ${intervention.matricule}\n`;
                content += `Type: ${intervention.interventionType}\n`;
                content += `Maintenance: ${intervention.maintenanceType}\n`;
                content += `Statut: ${intervention.status}\n`;
                content += `Début: ${formatDate(intervention.start)}\n`;
                content += `Fin: ${formatDate(intervention.end)}\n`;
                content += `Équipements: ${intervention.equipment.join(', ')}\n`;
                content += `Description: ${intervention.description || 'Aucune'}\n`;
                content += `\n--------------------------------\n\n`;
            });
            
            return content;
        }

        // Fonction pour envoyer l'email
        function shareViaEmail() {
            if (interventions.length === 0) {
                alert("Aucune intervention à envoyer!");
                return;
            }
            
            const subject = "Rapport des interventions de maintenance";
            const body = generateEmailContent();
            const email = "hamadamohamedvth@gmail.com";
            
            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            window.location.href = mailtoLink;
        }

        // Fonction pour partager via WhatsApp
        function shareViaWhatsApp() {
            if (interventions.length === 0) {
                alert("Aucune intervention à partager!");
                return;
            }
            
            const text = generateEmailContent();
            // WhatsApp impose une limite de 4096 caractères dans l'URL, donc on tronque si nécessaire
            const maxLength = 4096 - 50; // Réduire pour la marge
            let shareText = text;
            if (text.length > maxLength) {
                shareText = text.substring(0, maxLength) + "... [Tronqué]";
            }

            const encodedText = encodeURIComponent(shareText);
            const whatsappUrl = `https://wa.me/?text=${encodedText}`;
            window.open(whatsappUrl, '_blank');
        }

        // Fonction pour partager via WiFi (simulé)
        function shareViaWiFi() {
            if (interventions.length === 0) {
                alert("Aucune intervention à partager!");
                return;
            }
            
            // Dans une application réelle, cette fonction utiliserait une API de partage WiFi
            // Pour cette démo, nous allons simplement télécharger le fichier
            exportExcelBtn.click();
            showSyncStatus("Les interventions sont prêtes pour le transfert WiFi", true);
        }

        // Fonction pour exporter en Excel
        function exportToExcel() {
            exportExcelBtn.click();
        }

        // Gestion du menu de partage
        const shareBtn = document.getElementById('shareBtn');
        const shareOverlay = document.getElementById('shareOverlay');
        const closeShare = document.getElementById('closeShare');
        const whatsappShare = document.getElementById('whatsappShare');
        const emailShare = document.getElementById('emailShare');
        const wifiShare = document.getElementById('wifiShare');
        const excelShare = document.getElementById('excelShare');

        shareBtn.addEventListener('click', () => {
            shareOverlay.style.display = 'flex';
        });

        closeShare.addEventListener('click', () => {
            shareOverlay.style.display = 'none';
        });

        whatsappShare.addEventListener('click', () => {
            shareOverlay.style.display = 'none';
            shareViaWhatsApp();
        });

        emailShare.addEventListener('click', () => {
            shareOverlay.style.display = 'none';
            shareViaEmail();
        });

        wifiShare.addEventListener('click', () => {
            shareOverlay.style.display = 'none';
            shareViaWiFi();
        });

        excelShare.addEventListener('click', () => {
            shareOverlay.style.display = 'none';
            exportToExcel();
        });
        
        // Show sync status
        function showSyncStatus(message, isSuccess) {
            // Remove existing status
            const existingStatus = document.querySelector('.sync-status');
            if (existingStatus) existingStatus.remove();
            
            const statusEl = document.createElement('div');
            statusEl.className = 'sync-status';
            statusEl.innerHTML = `<i class="fas ${isSuccess ? 'fa-check-circle sync-success' : 'fa-times-circle sync-error'}"></i> ${message}`;
            
            document.body.appendChild(statusEl);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                statusEl.remove();
            }, 3000);
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Always start with login screen
            loginOverlay.style.display = 'flex';
            mainApp.style.display = 'none';
            sessionStatus.textContent = "Session sécurisée";
            
            // Prevent autocomplete
            usernameInput.autocomplete = "off";
            passwordInput.autocomplete = "off";
            
            // Clear any stored credentials
            usernameInput.value = '';
            passwordInput.value = '';
            
            // Add event listeners to filters
            filterType.addEventListener('change', renderInterventionList);
            filterMaintenance.addEventListener('change', renderInterventionList);
            filterStatus.addEventListener('change', renderInterventionList);
            searchInput.addEventListener('input', renderInterventionList);
            
            // Mobile optimizations
            document.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('touchstart', function() {
                    this.classList.add('active');
                });
                btn.addEventListener('touchend', function() {
                    this.classList.remove('active');
                });
            });
        });
    </script>
</body>
</html>